<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì–´ë””ë¡œ ê°ˆê¹Œ?</title>
  <style>
    /* ===== Reset & Base ===== */
    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Pretendard', -apple-system, BlinkMacSystemFont,
                   'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: #f0f2f5;
      color: #1a1a2e;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* ===== Header ===== */
    header {
      width: 100%;
      background: linear-gradient(135deg, #6c5ce7, #a29bfe);
      color: #fff;
      text-align: center;
      padding: 2rem 1rem 1.6rem;
    }

    header h1 {
      font-size: 1.8rem;
      font-weight: 700;
      letter-spacing: -0.02em;
    }

    header p {
      margin-top: 0.4rem;
      font-size: 0.95rem;
      opacity: 0.85;
    }

    /* ===== Main Container ===== */
    .container {
      width: 100%;
      max-width: 520px;
      padding: 1.5rem 1rem 3rem;
    }

    /* ===== Vote Cards ===== */
    .vote-card {
      background: #fff;
      border-radius: 14px;
      padding: 1.2rem 1.4rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    .vote-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(108, 92, 231, 0.15);
    }

    .vote-card:active {
      transform: scale(0.98);
    }

    .vote-card.voted {
      border: 2px solid #6c5ce7;
    }

    .vote-card .info {
      display: flex;
      align-items: center;
      gap: 0.8rem;
    }

    .vote-card .icon {
      font-size: 1.6rem;
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 12px;
      background: #f0f0f7;
      flex-shrink: 0;
    }

    .vote-card .name {
      font-size: 1.05rem;
      font-weight: 600;
    }

    .vote-card .count {
      font-size: 1.3rem;
      font-weight: 700;
      color: #6c5ce7;
      min-width: 36px;
      text-align: right;
    }

    /* ===== Bar Chart Section ===== */
    .results-section {
      margin-top: 1.2rem;
    }

    .results-section h2 {
      font-size: 1.1rem;
      font-weight: 700;
      margin-bottom: 1rem;
      color: #333;
    }

    .bar-row {
      display: flex;
      align-items: center;
      margin-bottom: 0.75rem;
      gap: 0.6rem;
    }

    .bar-label {
      width: 80px;
      font-size: 0.85rem;
      font-weight: 600;
      text-align: right;
      flex-shrink: 0;
    }

    .bar-track {
      flex: 1;
      height: 26px;
      background: #e9e9f0;
      border-radius: 13px;
      overflow: hidden;
      position: relative;
    }

    .bar-fill {
      height: 100%;
      border-radius: 13px;
      background: linear-gradient(90deg, #6c5ce7, #a29bfe);
      transition: width 0.5s ease;
      min-width: 0;
    }

    .bar-percent {
      width: 48px;
      font-size: 0.85rem;
      font-weight: 600;
      color: #555;
      flex-shrink: 0;
    }

    /* ===== Already-voted message ===== */
    .voted-message {
      text-align: center;
      padding: 1rem;
      background: #e8f5e9;
      border-radius: 12px;
      color: #2e7d32;
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 1rem;
    }

    /* ===== Total ===== */
    .total {
      text-align: center;
      margin-top: 0.6rem;
      font-size: 0.9rem;
      color: #888;
    }

    /* ===== Loading Spinner ===== */
    .loading {
      text-align: center;
      padding: 3rem 0;
      color: #999;
      font-size: 0.95rem;
    }

    .loading::after {
      content: '';
      display: block;
      width: 32px;
      height: 32px;
      margin: 1rem auto 0;
      border: 3px solid #ddd;
      border-top-color: #6c5ce7;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===== Footer ===== */
    footer {
      margin-top: auto;
      padding: 1.5rem;
      text-align: center;
      font-size: 0.8rem;
      color: #aaa;
    }

    /* ===== Responsive ===== */
    @media (max-width: 400px) {
      header h1 { font-size: 1.4rem; }
      .vote-card { padding: 1rem; }
      .bar-label { width: 60px; font-size: 0.78rem; }
    }
  </style>
</head>
<body>

  <header>
    <h1>ì–´ë””ë¡œ ê°ˆê¹Œ?</h1>
    <p>ê°€ê³  ì‹¶ì€ ì—¬í–‰ì§€ì— íˆ¬í‘œí•˜ì„¸ìš”!</p>
  </header>

  <div class="container">
    <!-- íˆ¬í‘œ ì¹´ë“œ ì˜ì—­ -->
    <div id="vote-cards">
      <div class="loading">íˆ¬í‘œ í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘</div>
    </div>

    <!-- ê²°ê³¼ ê·¸ë˜í”„ ì˜ì—­ -->
    <div class="results-section" id="results-section" style="display:none;">
      <h2>í˜„ì¬ íˆ¬í‘œ í˜„í™©</h2>
      <div id="bar-chart"></div>
      <p class="total" id="total-count"></p>
    </div>
  </div>

  <footer>Where Should We Go? &copy; 2025</footer>

  <!-- ============================================================
       Firebase SDK (v9 compat CDN)
       ============================================================ -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>

  <script>
    // =============================================================
    // [Firebase ì„¤ì •] ì•„ë˜ firebaseConfig ê°ì²´ì— ë³¸ì¸ì˜ Firebase
    // í”„ë¡œì íŠ¸ ì„¤ì • ê°’ì„ ì…ë ¥í•˜ì„¸ìš”.
    // Firebase ì½˜ì†” > í”„ë¡œì íŠ¸ ì„¤ì • > ë‚´ ì•± ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    // =============================================================
    const firebaseConfig = {
        apiKey: "AIzaSyC0QZqNQvsm7PvKN18eQ-LiaFLEz2O9wKs",
        authDomain: "travel-2d6c4.firebaseapp.com",
        projectId: "travel-2d6c4",
        storageBucket: "travel-2d6c4.firebasestorage.app",
        messagingSenderId: "120688909445",
        appId: "1:120688909445:web:b85ef3535a99912fc49dec"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // =============================================================
    // íˆ¬í‘œ í•­ëª© ì •ì˜ (ì´ë¦„, ì•„ì´ì½˜, Firestore ë¬¸ì„œ ID)
    // ì›í•˜ëŠ” ëŒ€ë¡œ í•­ëª©ì„ ì¶”ê°€/ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    // =============================================================
    const VOTE_ITEMS = [
      { id: "jeju",    name: "ì œì£¼ë„",   icon: "ğŸï¸" },
      { id: "busan",   name: "ë¶€ì‚°",     icon: "ğŸŒŠ" },
      { id: "gangwon", name: "ê°•ì›ë„",   icon: "â›°ï¸" },
      { id: "jeonju",  name: "ì „ì£¼",     icon: "ğŸ¯" },
    ];

    const COLLECTION  = "votes";         // Firestore ì»¬ë ‰ì…˜ ì´ë¦„
    const LS_KEY      = "voted_item";    // localStorage í‚¤

    // ----- DOM References -----
    const cardsEl     = document.getElementById("vote-cards");
    const resultsEl   = document.getElementById("results-section");
    const barChartEl  = document.getElementById("bar-chart");
    const totalEl     = document.getElementById("total-count");

    // ----- State -----
    let votedId = localStorage.getItem(LS_KEY);   // ì´ë¯¸ íˆ¬í‘œí•œ í•­ëª© ID (ì—†ìœ¼ë©´ null)
    let voteCounts = {};  // { itemId: number }

    // =============================================================
    // Firestore ì´ˆê¸° ë¬¸ì„œ ìƒì„± (ì—†ìœ¼ë©´ count: 0 ìœ¼ë¡œ ìë™ ìƒì„±)
    // =============================================================
    async function ensureDocuments() {
      const batch = db.batch();
      for (const item of VOTE_ITEMS) {
        const ref = db.collection(COLLECTION).doc(item.id);
        const doc = await ref.get();
        if (!doc.exists) {
          batch.set(ref, { count: 0 });
        }
      }
      await batch.commit();
    }

    // =============================================================
    // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (onSnapshot)
    // =============================================================
    function listenToVotes() {
      db.collection(COLLECTION).onSnapshot((snapshot) => {
        snapshot.forEach((doc) => {
          voteCounts[doc.id] = doc.data().count || 0;
        });
        renderCards();
        renderChart();
      });
    }

    // =============================================================
    // íˆ¬í‘œ ì²˜ë¦¬
    // =============================================================
    async function castVote(itemId) {
      if (votedId) return; // ì´ë¯¸ íˆ¬í‘œí•¨

      const ref = db.collection(COLLECTION).doc(itemId);
      await ref.update({
        count: firebase.firestore.FieldValue.increment(1),
      });

      votedId = itemId;
      localStorage.setItem(LS_KEY, itemId);
      renderCards();
    }

    // =============================================================
    // ì¹´ë“œ ë Œë”ë§
    // =============================================================
    function renderCards() {
      cardsEl.innerHTML = "";

      if (votedId) {
        const msg = document.createElement("div");
        msg.className = "voted-message";
        msg.textContent = "íˆ¬í‘œí•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤!";
        cardsEl.appendChild(msg);
      }

      for (const item of VOTE_ITEMS) {
        const card = document.createElement("div");
        card.className = "vote-card" + (votedId === item.id ? " voted" : "");

        card.innerHTML = `
          <div class="info">
            <div class="icon">${item.icon}</div>
            <div class="name">${item.name}</div>
          </div>
          <div class="count">${voteCounts[item.id] ?? 0}</div>
        `;

        if (!votedId) {
          card.addEventListener("click", () => castVote(item.id));
        } else {
          card.style.cursor = "default";
        }

        cardsEl.appendChild(card);
      }
    }

    // =============================================================
    // ë§‰ëŒ€ ê·¸ë˜í”„ ë Œë”ë§
    // =============================================================
    function renderChart() {
      resultsEl.style.display = "block";

      const total = VOTE_ITEMS.reduce((s, i) => s + (voteCounts[i.id] || 0), 0);
      totalEl.textContent = `ì´ ${total}í‘œ`;

      barChartEl.innerHTML = "";

      for (const item of VOTE_ITEMS) {
        const count   = voteCounts[item.id] || 0;
        const percent = total > 0 ? ((count / total) * 100).toFixed(1) : 0;

        const row = document.createElement("div");
        row.className = "bar-row";
        row.innerHTML = `
          <div class="bar-label">${item.icon} ${item.name}</div>
          <div class="bar-track">
            <div class="bar-fill" style="width: ${percent}%"></div>
          </div>
          <div class="bar-percent">${percent}%</div>
        `;
        barChartEl.appendChild(row);
      }
    }

    // =============================================================
    // ì´ˆê¸°í™”
    // =============================================================
    (async function init() {
      try {
        await ensureDocuments();
        listenToVotes();
      } catch (err) {
        cardsEl.innerHTML =
          '<p style="color:#e74c3c;text-align:center;padding:2rem;">' +
          'Firebase ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>Config ì„¤ì •ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>';
        console.error(err);
      }
    })();
  </script>
</body>
</html>
